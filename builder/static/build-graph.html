<html>

<h1>Build Graph!</h1>
<div id=""container">
    <style>
    #graph-container {
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      position: absolute;
    }
  </style>
    <div id="graph-container"></div>
    <div id="selection"></div>
</div>
<script src="/static/js/jquery.min.js"></script>
<script src="/static/js/vis.min.js"></script>
<!--<script src="/static/js/sigma.min.js"></script>
<script src="/static/js/sigma.layout.forceAtlas2.min.js"></script>-->
<script>

    var constructGraph = function(data) {
        // Build up the graph
        var targets = data['targets'];
        var jobs = data['jobs'];

        // Add target nodes
        console.log(targets, jobs);
        var g = {nodes: [], edges: []};
        var targetIndexLookup = {};
        var i = 0;
        for (var unexpanded_id in targets) {
            var target_ids = targets[unexpanded_id];

            for(var expanded_id in target_ids) {

                var target = target_ids[expanded_id];
                 g.nodes.push({
                    id: expanded_id,
                    label: expanded_id,
                    color: '#00FF00',
                    size: 40
                  });

                 targetIndexLookup[expanded_id] = i;
                 i += 1;
            }
        }

        // Add job nodes and edges
        i = 0;
        console.log(targetIndexLookup);
        for (var unexpanded_id in jobs) {
            var job_ids = jobs[unexpanded_id];
            for(var expanded_id in job_ids) {
                var job = job_ids[expanded_id];
                g.nodes.push({
                    id: expanded_id,
                    label: expanded_id,
                    color: '#FF0000',
                    size: 40
                  });
                for(var j in job.dependencies) {
                    var dependency_id = job.dependencies[j];
                    g.edges.push({from: expanded_id, to: dependency_id, arrows: 'to'});
                }
                for(var j in job.targets) {
                    var target_id = job.targets[j];
                    g.edges.push({from: expanded_id, to: target_id, arrows: 'from'});
                }
                i += 1;
            }
        }

        return g;
    }

    function getScaleFreeNetwork(nodeCount) {
      var nodes = [];
      var edges = [];
      var connectionCount = [];

      // randomly create some nodes and edges
      for (var i = 0; i < nodeCount; i++) {
        nodes.push({
          id: i,
          label: String(i)
        });

        connectionCount[i] = 0;

        // create edges in a scale-free-network way
        if (i == 1) {
          var from = i;
          var to = 0;
          edges.push({
            from: from,
            to: to
          });
          connectionCount[from]++;
          connectionCount[to]++;
        }
        else if (i > 1) {
          var conn = edges.length * 2;
          var rand = Math.floor(Math.random() * conn);
          var cum = 0;
          var j = 0;
          while (j < connectionCount.length && cum < rand) {
            cum += connectionCount[j];
            j++;
          }


          var from = i;
          var to = j;
          edges.push({
            from: from,
            to: to
          });
          connectionCount[from]++;
          connectionCount[to]++;
        }
      }

      return {nodes:nodes, edges:edges};
    }

    console.log(location.search);
    var qs = location.search;
    if(location.search[0] == '?') {
        qs = location.search.slice(1);
    }
    $.getJSON('/build-graph.json?'+qs+'&edges=true' + location.search,  function(data) {


        // Render graph
        var graph = constructGraph(data);
        var width = 960,
        height = 500;
        var nodeRadius = 5;


        var nodes = null;
        var edges = null;
        var network = null;
        function destroy() {
            if (network !== null) {
                network.destroy();
                network = null;
            }
        }
        function draw() {
            destroy();
            // randomly create some nodes and edges
            //var nodeCount = 50;
            //var graph = getScaleFreeNetwork(nodeCount)
            console.log(graph);
            // create a network
            var container = document.getElementById('graph-container');
            var directionInput = 'LR';
            var options = {
                layout: {
                    hierarchical: {
                        direction: directionInput,
                        levelSeparation: 1000
                    }
                }
            };
            network = new vis.Network(container, graph, options);
            // add event listeners
            network.on('select', function (params) {
                document.getElementById('selection').innerHTML = 'Selection: ' + params.nodes;
            });
        }

        draw();




    });

//        for (i = 0; i < E; i++)
//          g.edges.push({
//            id: 'e' + i,
//            source: 'n' + (Math.random() * N | 0),
//            target: 'n' + (Math.random() * N | 0),
//            size: Math.random(),
//            color: '#ccc'
//          });

</script>
</html>